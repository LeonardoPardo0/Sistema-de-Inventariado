version: '3.8'

services:
  # ======================================================
  # MongoDB para Auth Service
  # ======================================================
  mongodb-auth:
    image: mongo:7.0
    container_name: mongodb-auth
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: authdb
    volumes:
      - mongodb_auth_data:/data/db
    networks:
      - microservices-network

  # ======================================================
  # MongoDB para Products Service
  # ======================================================
  mongodb-products:
    image: mongo:7.0
    container_name: mongodb-products
    restart: always
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: productsdb
    volumes:
      - mongodb_products_data:/data/db
    networks:
      - microservices-network

  # ======================================================
  # MongoDB para Inventory Service
  # ======================================================
  mongodb-inventory:
    image: mongo:7.0
    container_name: mongodb-inventory
    restart: always
    ports:
      - "27019:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: inventorydb
    volumes:
      - mongodb_inventory_data:/data/db
    networks:
      - microservices-network

# ======================================================
  # MongoDB para Orders Service
  # ======================================================
  mongodb-orders:
    image: mongo:7.0
    container_name: mongodb-orders
    restart: always
    ports:
      - "27020:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ordersdb
    volumes:
      - mongodb_orders_data:/data/db
    networks:
      - microservices-network

  # ======================================================
  # Servicio de Autenticación (Auth)
  # ======================================================
  auth-service:
    build: ./services/auth-service
    container_name: auth-service
    restart: always
    ports:
      - "${AUTH_PORT}:3000"
    environment:
      PORT: 3000
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb-auth:27017/authdb?authSource=admin
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}
    depends_on:
      - mongodb-auth
    networks:
      - microservices-network
    volumes:
      - ./services/auth-service:/app
      - /app/node_modules

  # ======================================================
  # Servicio de Productos
  # ======================================================
  products-service:
    build: ./services/products-service
    container_name: products-service
    restart: always
    ports:
      - "${PRODUCTS_PORT}:3001"
    environment:
      PORT: 3001
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb-products:27017/productsdb?authSource=admin
      AUTH_SERVICE_URL: http://auth-service:3000
    depends_on:
      - mongodb-products
      - auth-service
    networks:
      - microservices-network
    volumes:
      - ./services/products-service:/app
      - /app/node_modules

  # ======================================================
  # Servicio de Inventario
  # ======================================================
  inventory-service:
    build: ./services/inventory-service
    container_name: inventory-service
    restart: always
    ports:
      - "${INVENTORY_PORT}:3002"
    environment:
      PORT: 3002
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb-inventory:27017/inventorydb?authSource=admin
      PRODUCTS_SERVICE_URL: http://products-service:3001
      AUTH_SERVICE_URL: http://auth-service:3000
    depends_on:
      - mongodb-inventory
      - products-service
      - auth-service
    networks:
      - microservices-network
    volumes:
      - ./services/inventory-service:/app
      - /app/

  orders-service:
    build: ./services/orders-service
    container_name: orders-service
    restart: always
    ports:
      - "${ORDERS_PORT}:3003"
    environment:
      PORT: 3003
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb-orders:27017/ordersdb?authSource=admin
      AUTH_SERVICE_URL: http://auth-service:3000
      PRODUCTS_SERVICE_URL: http://products-service:3001
      INVENTORY_SERVICE_URL: http://inventory-service:3002
    depends_on:
      - mongodb-orders
      - auth-service
      - products-service
      - inventory-service
    networks:
      - microservices-network
    volumes:
      - ./services/orders-service:/app
      - /app/node_modules
  
  # ======================================================
  # API Gateway (Nginx)
  # ======================================================
  api-gateway:
    image: nginx:alpine
    container_name: api-gateway
    restart: always
    ports:
      - "${GATEWAY_PORT}:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend:/usr/share/nginx/html  # ← AGREGAR ESTA LÍNEA
    depends_on:
      - auth-service
      - products-service
      - inventory-service
      - orders-service
        #- billing-service
        #- reports-service
    networks:
      - microservices-network

# ======================================================
# Redes y volúmenes
# ======================================================
networks:
  microservices-network:
    driver: bridge

volumes:
  mongodb_auth_data:
  mongodb_products_data:
  mongodb_inventory_data:
  mongodb_orders_data:
  mongodb_billing_data:
  mongodb_reports_data: